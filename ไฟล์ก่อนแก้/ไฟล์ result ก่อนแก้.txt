import { useEffect, useState } from 'react';
import { API } from '../services/api';
import { motion, AnimatePresence } from 'framer-motion';
import { Download, ArrowLeft, SearchX, Loader, Eye, X, FileText, Sparkles, Cloud, ExternalLink, ChevronLeft, ChevronRight, Star, Heart } from 'lucide-react';
import QRCode from "react-qr-code";

export default function ResultsPage({ age, categories, onBack }) {
  const [worksheets, setWorksheets] = useState([]);
  const [loading, setLoading] = useState(true);
  const [preview, setPreview] = useState(null);

  // Pagination State
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 8; // Keep 8 items for the 4x2 grid

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      try {
        const allData = await API.getWorksheets();
        const filtered = allData.filter(item => {
            const itemAgeString = String(item.ageRange || '').trim();
            const selectedAge = String(age || '').trim();
            const ageMatch = itemAgeString.includes(selectedAge);
            const catMatch = categories.includes(item.category);
            return ageMatch && catMatch;
        });

        setWorksheets(filtered);
        setCurrentPage(1);
      } catch (error) {
        console.error("Error fetching data:", error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [age, categories]);

  // Pagination Logic
  const indexOfLastItem = currentPage * itemsPerPage;
  const indexOfFirstItem = indexOfLastItem - itemsPerPage;
  const currentItems = worksheets.slice(indexOfFirstItem, indexOfLastItem);
  const totalPages = Math.ceil(worksheets.length / itemsPerPage);

  const goToNextPage = () => { if (currentPage < totalPages) setCurrentPage(prev => prev + 1); };
  const goToPrevPage = () => { if (currentPage > 1) setCurrentPage(prev => prev - 1); };
  const goToPage = (n) => setCurrentPage(n);

  // Helper to generate page numbers
  const getPageNumbers = () => {
      const pageNumbers = [];
      for (let i = 1; i <= totalPages; i++) {
          pageNumbers.push(i);
      }
      return pageNumbers;
  };

  return (
    // เปลี่ยนพื้นหลังให้มีสีสันนุ่มๆ และดูสะอาดตา
    <div className="h-full flex flex-col items-center justify-center w-full px-4 relative overflow-hidden bg-[#FFFDF9]">
        
        {/* Background Decor: ใช้รูปทรงเลขาคณิตสีพาสเทลลอยๆ แทน Texture เดิม */}
        <div className="absolute top-[-10%] left-[-10%] w-64 h-64 bg-rose-100 rounded-full blur-3xl opacity-40 pointer-events-none"></div>
        <div className="absolute bottom-[-10%] right-[-10%] w-80 h-80 bg-blue-100 rounded-full blur-3xl opacity-40 pointer-events-none"></div>
        <div className="absolute top-[20%] right-[10%] w-32 h-32 bg-yellow-100 rounded-full blur-2xl opacity-50 pointer-events-none"></div>
        
        {/* ไอคอนตกแต่งพื้นหลัง (ดึงมาจาก Lucide) */}
        <div className="absolute top-10 left-[5%] text-rose-200 animate-bounce delay-700 hidden md:block opacity-40 pointer-events-none"><Cloud size={80} fill="currentColor" strokeWidth={0} /></div>
        <div className="absolute bottom-20 right-[5%] text-sky-200 animate-pulse hidden md:block opacity-40 pointer-events-none"><Star size={60} fill="currentColor" strokeWidth={0}/></div>

        {/* Main Content Container */}
        <div className="w-full max-w-6xl flex flex-col items-center justify-center py-4 z-10 h-full">

            {/* 1. HEADER: ปรับให้ดูขี้เล่นและโค้งมนขึ้น */}
            <div className="text-center mb-2 relative z-10 w-full flex flex-col items-center">
                 {/* Back Button */}
                 <div className="absolute left-0 top-1 hidden md:block">
                    <button onClick={onBack} className="group flex items-center justify-center w-12 h-12 rounded-2xl bg-white border-2 border-slate-100 text-slate-400 hover:text-white hover:bg-rose-400 hover:border-rose-400 shadow-[0_4px_0_0_rgba(241,245,249,1)] hover:shadow-[0_4px_0_0_rgba(225,29,72,0.2)] transition-all active:translate-y-1 active:shadow-none">
                        <ArrowLeft size={24} strokeWidth={3} />
                    </button>
                 </div>

                {/* Badge หมวดวิชา */}
                <div className="inline-flex items-center gap-2 bg-white px-6 py-2 rounded-full shadow-sm mb-3 border-2 border-sky-100">
                     <span className="w-2 h-2 rounded-full bg-sky-400 animate-pulse"></span>
                     <span className="text-slate-500 font-extrabold text-xs tracking-wide">
                        วิชา: <span className="text-sky-500">{categories.slice(0, 2).join(', ')}{categories.length > 2 ? '...' : ''}</span>
                    </span>
                </div>
                
                <h1 className="text-3xl md:text-5xl font-black text-slate-700 mb-1 tracking-tight drop-shadow-sm">
                    ใบงานน้อง <span className="text-rose-500 inline-block transform hover:rotate-3 transition-transform cursor-default">{age}</span>
                </h1>
            </div>

            {/* 2. CONTENT AREA (Grid) */}
            <div className="w-full flex-1 flex flex-col justify-start overflow-hidden relative px-2 md:px-4">
                {loading ? (
                    <div className="flex flex-col items-center justify-center h-full gap-3">
                        <div className="relative">
                            <div className="w-16 h-16 border-4 border-rose-100 border-t-rose-400 rounded-full animate-spin"></div>
                            <div className="absolute inset-0 flex items-center justify-center"><Loader size={24} className="text-rose-400"/></div>
                        </div>
                        <p className="text-rose-400 font-bold text-lg animate-pulse">กำลังเตรียมใบงาน...</p>
                    </div>
                ) : worksheets.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-full opacity-60 bg-white/50 rounded-3xl border-2 border-dashed border-slate-200 m-4">
                        <SearchX size={64} className="text-slate-300 mb-4"/>
                        <p className="text-lg font-bold text-slate-400">ยังไม่มีใบงานในหมวดนี้จ้า</p>
                    </div>
                ) : (
                    <AnimatePresence mode='wait'>
                        <motion.div 
                            key={currentPage}
                            initial={{ opacity: 0, scale: 0.95 }} 
                            animate={{ opacity: 1, scale: 1 }} 
                            exit={{ opacity: 0, scale: 0.95 }} 
                            transition={{ duration: 0.3, type: "spring" }}
                            className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 grid-rows-2 gap-4 md:gap-6 h-full max-h-[calc(100%-70px)] p-2"
                        >
                            {currentItems.map((sheet) => (
                                <motion.div 
                                    key={sheet.id}
                                    whileHover={{ y: -5, scale: 1.02 }}
                                    className="group relative bg-white p-3 rounded-[24px] shadow-sm hover:shadow-xl border-2 border-slate-100 hover:border-rose-200 transition-all duration-300 cursor-pointer flex flex-col h-full overflow-hidden"
                                    onClick={() => setPreview(sheet)}
                                >
                                    {/* Image Area */}
                                    <div className="relative w-full flex-1 overflow-hidden rounded-[18px] bg-slate-50 mb-3 border border-slate-100 aspect-[3/4] group-hover:border-rose-100 transition-colors">
                                        <div className="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity z-10"/>
                                        <img 
                                            src={sheet.imageUrl} 
                                            alt={sheet.title} 
                                            className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" 
                                            onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/300x400/png?text=No+Image"; }} 
                                        />
                                        {/* Category Badge */}
                                        <div className="absolute top-2 left-2 z-20">
                                            <span className="bg-white/95 px-2 py-1 rounded-lg text-[10px] font-extrabold text-indigo-500 shadow-sm border border-indigo-50 flex items-center gap-1">
                                                <Star size={8} fill="currentColor" className="text-yellow-400" />
                                                {sheet.category}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    {/* Content Area */}
                                    <div className="flex flex-col shrink-0 justify-between h-[55px]"> 
                                        <h3 className="font-bold text-slate-700 text-sm leading-tight line-clamp-1 text-center group-hover:text-rose-500 transition-colors px-1">
                                            {sheet.title}
                                        </h3>
                                        <button className="w-full mt-auto py-1.5 rounded-xl bg-indigo-50 text-indigo-500 font-bold text-xs border border-indigo-100 group-hover:bg-rose-500 group-hover:text-white group-hover:border-rose-500 transition-all shadow-sm flex items-center justify-center gap-1">
                                            <Eye size={14} />
                                            ดูตัวอย่าง
                                        </button>
                                    </div>
                                </motion.div>
                            ))}
                        </motion.div>
                    </AnimatePresence>
                )}
            </div>

            {/* 3. PAGINATION BAR: ปรับให้ปุ่มใหญ่ขึ้นและกดง่าย */}
            {!loading && totalPages > 1 && (
                <div className="mt-2 flex-none flex justify-center items-center z-20">
                    <div className="flex items-center gap-3 bg-white px-2 py-2 rounded-2xl shadow-lg shadow-indigo-100/50 border border-indigo-50">
                        <button onClick={goToPrevPage} disabled={currentPage === 1} className={`w-10 h-10 flex items-center justify-center rounded-xl transition-all border-2 ${currentPage === 1 ? 'text-slate-200 border-slate-100 bg-slate-50' : 'text-rose-500 border-rose-100 hover:bg-rose-500 hover:text-white hover:border-rose-500'}`}>
                            <ChevronLeft size={24} strokeWidth={3} />
                        </button>

                        <div className="flex items-center gap-1 px-2">
                            {getPageNumbers().map((number) => (
                                <button
                                    key={number}
                                    onClick={() => goToPage(number)}
                                    className={`w-9 h-9 rounded-xl font-black text-sm transition-all transform active:scale-90 ${
                                        currentPage === number 
                                            ? 'bg-rose-500 text-white shadow-md shadow-rose-200 scale-110' 
                                            : 'bg-transparent text-slate-400 hover:bg-slate-50 hover:text-rose-500'
                                    }`}
                                >
                                    {number}
                                </button>
                            ))}
                        </div>

                        <button onClick={goToNextPage} disabled={currentPage === totalPages} className={`w-10 h-10 flex items-center justify-center rounded-xl transition-all border-2 ${currentPage === totalPages ? 'text-slate-200 border-slate-100 bg-slate-50' : 'text-rose-500 border-rose-100 hover:bg-rose-500 hover:text-white hover:border-rose-500'}`}>
                            <ChevronRight size={24} strokeWidth={3} />
                        </button>
                    </div>
                </div>
            )}

            {/* Modal Preview: ปรับให้เหมือน Pop-up card */}
            <AnimatePresence>
                {preview && (
                    <div className="fixed inset-0 bg-indigo-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setPreview(null)}>
                        <motion.div 
                            initial={{ scale: 0.8, opacity: 0, rotateX: 10 }} 
                            animate={{ scale: 1, opacity: 1, rotateX: 0 }} 
                            exit={{ scale: 0.8, opacity: 0 }} 
                            transition={{ type: "spring", damping: 25, stiffness: 300 }}
                            className="bg-white w-full max-w-4xl h-[85vh] rounded-[32px] shadow-2xl flex flex-col relative overflow-hidden ring-8 ring-white/30" 
                            onClick={e => e.stopPropagation()}
                        >
                            {/* Header Bar of Modal */}
                            <div className="absolute top-0 left-0 right-0 h-16 bg-gradient-to-b from-white to-transparent z-40 pointer-events-none"></div>
                            <button onClick={() => setPreview(null)} className="absolute top-4 right-4 z-50 w-10 h-10 bg-white rounded-full shadow-lg border border-slate-100 text-slate-400 hover:text-rose-500 hover:rotate-90 transition-all flex items-center justify-center">
                                <X size={24} strokeWidth={3}/>
                            </button>

                            {/* Preview Area */}
                            <div className="flex-1 flex items-center justify-center bg-[#F8FAFC] p-6">
                                {preview.pdfUrl ? (
                                    <iframe src={preview.pdfUrl} className="w-full h-full rounded-2xl border-4 border-white shadow-sm bg-white" title="PDF Preview"></iframe>
                                ) : (
                                    <img src={preview.imageUrl} className="h-full object-contain rounded-2xl shadow-lg border-4 border-white bg-white" alt="Preview"/>
                                )}
                            </div>

                            {/* Footer Action Bar */}
                            <div className="flex flex-col md:flex-row justify-between items-center p-5 bg-white border-t-2 border-slate-50 gap-4">
                                <div className="flex items-center gap-4 bg-indigo-50/50 p-2 pr-6 rounded-2xl border border-indigo-50">
                                    <div className="bg-white p-2 rounded-xl shadow-sm">
                                        <QRCode value={preview.pdfUrl || '#'} size={48} fgColor="#4F46E5" bgColor="transparent"/>
                                    </div>
                                    <div className="text-left">
                                        <p className="text-[10px] text-indigo-400 font-black uppercase tracking-wider mb-0.5">Scan to Mobile</p>
                                        <p className="text-slate-700 font-bold text-sm">สแกนไปทำบนมือถือ</p>
                                    </div>
                                </div>

                                <a href={preview.pdfUrl} target="_blank" className="flex items-center gap-3 bg-rose-500 text-white px-8 py-3 rounded-2xl font-bold text-base shadow-[0_4px_0_0_rgba(190,18,60,1)] hover:shadow-[0_2px_0_0_rgba(190,18,60,1)] hover:translate-y-[2px] active:shadow-none active:translate-y-[4px] transition-all w-full md:w-auto justify-center">
                                    <Download size={20} strokeWidth={3}/> 
                                    ดาวน์โหลด PDF
                                </a>
                            </div>
                        </motion.div>
                    </div>
                )}
            </AnimatePresence>

        </div>
    </div>
  );
}